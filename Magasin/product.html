<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accueil - Magasin en Ligne</title>
    <link rel="stylesheet" href="css/reset.css">

    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/composant.css">
    <link rel="stylesheet" href="css/pages.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>

<body class="product-detail-page">
    <header>
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="home.html" class="back-link">‚Üê Retour</a>
            <a href="panier.html" style="font-size: 27px; text-decoration: none; position: relative;">
                üõí
                <span class="cart-badge" id="cartBadge"
                    style="position: absolute; top: -8px; right: -8px; background: #E59A59; color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">0</span>
            </a>
        </div>
    </header>

    <main class="container product-detail-layout">
        
        <section class="product-gallery">
            <div class="gallery-main">
                <img src="" alt="Image du produit" class="main-image" id="main-image">
            </div>
            <div class="gallery-thumbnails">
                <img src="" alt="Vue 1" class="thumbnail" id="thumb-1" data-image="1">
                <img src="" alt="Vue 2" class="thumbnail" id="thumb-2" data-image="2">
                <img src="" alt="Vue 3" class="thumbnail" id="thumb-3" data-image="3">
            </div>
        </section>

        
        <section class="product-details">
            <div class="product-header">
                <h1 id="product-title">Titre du produit</h1>
                <p class="product-subtitle" id="product-subtitle">Sous-titre du produit</p>
            </div>

            <div class="product-rating" id="product-rating">
                <span class="stars">&nbsp;</span>
                <span class="review-count">&nbsp;</span>
            </div>

            <p class="product-price-detail" id="product-price-detail">&nbsp;</p>

            <div class="product-options">
                <div class="option-group quantity-group">
                    <label for="quantity">Quantit√©:</label>
                    <input type="number" id="quantity" class="qty-input" min="1" value="1">
                </div>
                <button class="btn btn-primary full add-to-cart-btn" id="add-to-cart-btn">Ajouter au Panier</button>
            </div>

            
            <section class="product-description" id="product-description">
                <h2>Description</h2>
                <p id="product-description-text">Les d√©tails du produit seront affich√©s ici.</p>
                <h3>Composition</h3>
                <ul class="composition-list" id="product-composition"></ul>
                <h3>B√©n√©fices</h3>
                <ul class="benefits-list" id="product-benefits"></ul>
            </section>
        </section>
    </main>

    <footer class="product-footer">
        <div class="container">
            <p>&copy; 2026 Magasin de Cosm√©tiques.</p>
        </div>
    </footer>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
        const API_BASE = window.API_BASE || 'http://localhost:4000';
        const API_URL = API_BASE + '/api/products';

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            document.querySelector('main').innerHTML = '<p>Produit non trouv√©</p>';
        } else {
            loadProductDetail();
        }

        async function loadProductDetail() {
            try {
                const response = await fetch(`${API_URL}/${productId}`);
                if (!response.ok) throw new Error('Produit non trouv√©');

                const product = await response.json();
                console.log('‚úÖ Product loaded:', product);

                document.getElementById('product-title').textContent = product.name || '';
                document.getElementById('product-subtitle').textContent = product.category || '';
                document.getElementById('product-price-detail').textContent = `${product.price} DA`;

                // Rating placeholder (API has no rating yet)
                var ratingEl = document.getElementById('product-rating');
                if (ratingEl) {
                    var stars = ratingEl.querySelector('.stars');
                    var reviewCount = ratingEl.querySelector('.review-count');
                    if (stars) stars.textContent = product.rating ? '‚òÖ'.repeat(Math.min(5, Math.round(product.rating))) + '‚òÜ'.repeat(5 - Math.min(5, Math.round(product.rating))) : '';
                    if (reviewCount) reviewCount.textContent = product.reviewCount ? '(' + product.reviewCount + ' avis)' : 'Aucune note';
                }
                document.getElementById('product-description-text').textContent = product.description || '';

                const mainImg = document.getElementById('main-image');
                const thumb1 = document.getElementById('thumb-1');
                const thumb2 = document.getElementById('thumb-2');
                const thumb3 = document.getElementById('thumb-3');

                const img1Url = normPath(product.image1) || 'https://via.placeholder.com/400x500?text=Image+1';
                const img2Url = product.image2 ? normPath(product.image2) : img1Url;
                const img3Url = product.image3 ? normPath(product.image3) : img1Url;

                mainImg.src = img1Url;
                thumb1.src = img1Url;
                thumb2.src = img2Url;
                thumb3.src = img3Url;

                // Add click handlers for thumbnails
                thumb1.addEventListener('click', () => mainImg.src = img1Url);
                thumb2.addEventListener('click', () => mainImg.src = img2Url);
                thumb3.addEventListener('click', () => mainImg.src = img3Url);

                // Add to cart button
                document.getElementById('add-to-cart-btn').addEventListener('click', () => {
                    addToCart(product);
                });

                // Render Composition and B√©n√©fices as bulleted lists
                const compUl = document.getElementById('product-composition');
                const benUl = document.getElementById('product-benefits');

                function setListAndToggleHeader(ul, items) {
                    ul.innerHTML = '';
                    const header = ul.previousElementSibling; // the <h3> before the ul
                    if (!items || !items.length) {
                        if (header) header.style.display = 'none';
                        ul.style.display = 'none';
                        return;
                    }
                    if (header) header.style.display = '';
                    ul.style.display = '';
                    items.forEach(it => {
                        const li = document.createElement('li');
                        li.textContent = it;
                        ul.appendChild(li);
                    });
                }

                // Accept arrays (from API) or newline-separated strings
                const compositionItems = Array.isArray(product.composition)
                    ? product.composition
                    : (product.composition ? String(product.composition).split(/\r?\n/).map(s => s.trim()).filter(Boolean) : []);

                const beneficesItems = Array.isArray(product.benefices)
                    ? product.benefices
                    : (product.benefices ? String(product.benefices).split(/\r?\n/).map(s => s.trim()).filter(Boolean) : []);

                setListAndToggleHeader(compUl, compositionItems);
                setListAndToggleHeader(benUl, beneficesItems);

            } catch (error) {
                console.error('Error loading product:', error);
                document.querySelector('main').innerHTML = '<p>Erreur: ' + error.message + '</p>';
            }
        }

        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const total = cart.reduce((sum, item) => sum + item.quantity, 0);
            const badge = document.getElementById('cartBadge');
            if (badge) {
                badge.textContent = total;
                badge.style.display = total > 0 ? 'flex' : 'none';
            }
        }

        function addToCart(product) {
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            let cart = JSON.parse(localStorage.getItem('cart')) || [];

            // Build image URL (normalized)
            const imageUrl = normPath(product.image1) || 'https://via.placeholder.com/80x80?text=No+Image';

            const existing = cart.find(item => item.id === product.id);

            if (existing) {
                existing.quantity += quantity;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: imageUrl,
                    quantity: quantity
                });
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartBadge();
            alert(`${product.name} ajout√© au panier!`);
            document.getElementById('quantity').value = 1;
        }

        // Initialize badge on load
        document.addEventListener('DOMContentLoaded', () => {
            updateCartBadge();
        });
    </script>
</body>

</html>